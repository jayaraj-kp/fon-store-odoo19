<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ── Sale Order Form: add cost / margin columns ── -->
        <record id="view_order_form_smb" model="ir.ui.view">
            <field name="name">sale.order.form.smb</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">

                <!-- Alert banner at top of sheet -->
                <xpath expr="//form[@class='o_sale_order']//sheet" position="inside">
                    <div class="alert alert-warning mb-0"
                         invisible="not smb_has_threshold_breach">
                        <i class="fa fa-exclamation-triangle me-1"/>
                        <strong>Margin / Cost Alert:</strong>
                        One or more lines breach the configured thresholds.
                        Confirming or invoicing this order may be blocked.
                        See the <b>Margin %</b> and <b>Cost Recovery %</b> columns below.
                    </div>
                </xpath>

                <!-- Add margin columns inside the order_line list, before price_subtotal -->
                <xpath expr="//page[@name='order_lines']//field[@name='order_line']//list//field[@name='price_subtotal'][1]" position="before">
                    <field name="smb_unit_cost" string="Unit Cost" optional="show"
                           widget="monetary" options="{'currency_field': 'currency_id'}"/>
                    <field name="smb_margin_amount" string="Margin" optional="show"
                           widget="monetary" options="{'currency_field': 'currency_id'}"/>
                    <field name="smb_margin_percent" string="Margin %" optional="show"
                           decoration-danger="smb_below_threshold == True"/>
                    <field name="smb_cost_recovery_percent" string="Cost Recovery %" optional="show"
                           decoration-danger="smb_below_threshold == True"/>
                    <field name="smb_below_threshold" column_invisible="1"/>
                </xpath>

                <!-- Order-level margin totals: insert after the totals button group -->
                <xpath expr="//div[@name='so_button_below_order_lines']" position="after">
                    <group class="oe_subtotal_footer">
                        <field name="smb_order_margin_amount" string="Total Margin"
                               widget="monetary"/>
                        <field name="smb_order_margin_percent" string="Margin %"/>
                    </group>
                </xpath>

            </field>
        </record>

        <!-- ── Sale Order List: add margin % column ── -->
        <record id="view_order_list_smb" model="ir.ui.view">
            <field name="name">sale.order.list.smb</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.sale_order_tree"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='amount_total']" position="after">
                    <field name="smb_order_margin_percent" string="Margin %"
                           optional="show"
                           decoration-danger="smb_has_threshold_breach == True"/>
                    <field name="smb_has_threshold_breach" column_invisible="1"/>
                </xpath>
            </field>
        </record>

    </data>
</odoo>

