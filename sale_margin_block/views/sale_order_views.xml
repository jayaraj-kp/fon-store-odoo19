<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ── Sale Order Line: add cost / margin columns ── -->
        <record id="view_order_form_smb" model="ir.ui.view">
            <field name="name">sale.order.form.smb</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_order_form"/>
            <field name="arch" type="xml">

                <!-- Alert banner below the status bar -->
                <xpath expr="//div[hasclass('o_field_widget')][1]" position="before">
                    <div class="alert alert-warning mb-0"
                         attrs="{'invisible': [('smb_has_threshold_breach', '=', False)]}">
                        <i class="fa fa-exclamation-triangle me-1"/>
                        <strong>Margin / Cost Alert:</strong>
                        One or more lines breach the configured thresholds.
                        Confirming or invoicing this order may be blocked.
                        See the <b>Margin %</b> and <b>Cost Recovery %</b> columns below for details.
                    </div>
                </xpath>

                <!-- Margin summary in the totals area -->
                <xpath expr="//field[@name='amount_total']" position="after">
                    <field name="smb_order_margin_amount" string="Order Margin"
                           widget="monetary"/>
                    <field name="smb_order_margin_percent" string="Margin %"
                           widget="percentage"/>
                </xpath>

                <!-- Columns in the order line tree -->
                <xpath expr="//field[@name='price_subtotal']" position="before">
                    <field name="smb_unit_cost" string="Unit Cost" optional="show"
                           widget="monetary" options="{'currency_field': 'currency_id'}"/>
                    <field name="smb_margin_amount" string="Margin" optional="show"
                           widget="monetary" options="{'currency_field': 'currency_id'}"/>
                    <field name="smb_margin_percent" string="Margin %" optional="show"
                           widget="percentage"
                           decoration-danger="smb_below_threshold == True"/>
                    <field name="smb_cost_recovery_percent" string="Cost Recovery %" optional="show"
                           widget="percentage"
                           decoration-danger="smb_below_threshold == True"/>
                    <!-- hidden helper field for decoration -->
                    <field name="smb_below_threshold" column_invisible="1"/>
                </xpath>

            </field>
        </record>

        <!-- ── Sale Order List: add breach indicator ── -->
        <record id="view_quotation_with_onboarding_smb" model="ir.ui.view">
            <field name="name">sale.order.list.smb</field>
            <field name="model">sale.order</field>
            <field name="inherit_id" ref="sale.view_quotation_with_onboarding"/>
            <field name="arch" type="xml">
                <xpath expr="//field[@name='amount_total']" position="after">
                    <field name="smb_order_margin_percent" string="Margin %"
                           optional="show" widget="percentage"
                           decoration-danger="smb_has_threshold_breach == True"/>
                    <field name="smb_has_threshold_breach" column_invisible="1"/>
                </xpath>
            </field>
        </record>

    </data>
</odoo>
