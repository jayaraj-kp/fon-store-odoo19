<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <record id="res_config_settings_view_form_smb" model="ir.ui.view">
            <field name="name">res.config.settings.view.form.smb</field>
            <field name="model">res.config.settings</field>
            <field name="inherit_id" ref="sale.res_config_settings_view_form"/>
            <field name="arch" type="xml">

                <!-- Append a new section at the end of the Sales settings page -->
                <xpath expr="//div[hasclass('settings')]" position="inside">

                    <div class="app_settings_block" data-string="Margin &amp; Cost Block"
                         string="Margin &amp; Cost Block" data-key="sale_margin_block">

                        <h2>Margin &amp; Cost Block</h2>
                        <p class="text-muted">
                            Prevent order confirmation and invoicing when margin or
                            cost-recovery falls below the configured thresholds.
                        </p>

                        <!-- ── Margin block ── -->
                        <div class="row mt16 o_settings_container">
                            <div class="col-12 col-lg-6 o_setting_box">
                                <div class="o_setting_left_pane">
                                    <field name="sale_margin_block_enabled"/>
                                </div>
                                <div class="o_setting_right_pane">
                                    <label for="sale_margin_block_enabled" string="Block by Margin %"/>
                                    <div class="text-muted">
                                        Block orders/invoices when any line's margin % is below the minimum.
                                    </div>
                                    <div attrs="{'invisible': [('sale_margin_block_enabled', '=', False)]}">
                                        <div class="mt8">
                                            <label for="sale_margin_minimum" string="Minimum Margin %"/>
                                            <field name="sale_margin_minimum"
                                                   class="o_field_number"
                                                   widget="float"
                                                   attrs="{'required': [('sale_margin_block_enabled', '=', True)]}"/>
                                            <span class="o_form_label">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- ── Cost-recovery block ── -->
                            <div class="col-12 col-lg-6 o_setting_box">
                                <div class="o_setting_left_pane">
                                    <field name="sale_cost_block_enabled"/>
                                </div>
                                <div class="o_setting_right_pane">
                                    <label for="sale_cost_block_enabled" string="Block by Cost Recovery %"/>
                                    <div class="text-muted">
                                        Block when the selling price is below a % of the product cost.
                                        100 % means price must at least equal cost.
                                    </div>
                                    <div attrs="{'invisible': [('sale_cost_block_enabled', '=', False)]}">
                                        <div class="mt8">
                                            <label for="sale_cost_minimum" string="Minimum Cost Recovery %"/>
                                            <field name="sale_cost_minimum"
                                                   class="o_field_number"
                                                   widget="float"
                                                   attrs="{'required': [('sale_cost_block_enabled', '=', True)]}"/>
                                            <span class="o_form_label">%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- ── Warn-only / override ── -->
                        <div class="row o_settings_container"
                             attrs="{'invisible': [('sale_margin_block_enabled', '=', False),
                                                   ('sale_cost_block_enabled', '=', False)]}">
                            <div class="col-12 col-lg-6 o_setting_box">
                                <div class="o_setting_left_pane">
                                    <field name="sale_margin_block_warn_only"/>
                                </div>
                                <div class="o_setting_right_pane">
                                    <label for="sale_margin_block_warn_only" string="Warn Only (no hard block)"/>
                                    <div class="text-muted">
                                        When enabled, threshold breaches only generate a chatter warning
                                        instead of blocking the operation.
                                        Users with the <b>Can Override Margin/Cost Block</b> group
                                        are never hard-blocked regardless of this setting.
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </xpath>

            </field>
        </record>

    </data>
</odoo>
