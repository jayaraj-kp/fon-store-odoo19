<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <data>

        <!-- ══════════════════════════════════════════════════════════════════
             Standalone configuration form for Margin & Cost Block settings.
             Avoids inheriting the Sale settings view (whose structure changes
             between Odoo versions) by providing its own form + menu entry.
        ══════════════════════════════════════════════════════════════════════ -->

        <!-- Transient model view -->
        <record id="view_smb_config_form" model="ir.ui.view">
            <field name="name">smb.config.form</field>
            <field name="model">res.config.settings</field>
            <field name="arch" type="xml">
                <form string="Margin &amp; Cost Block — Settings" class="oe_form_configuration">

                    <header>
                        <button string="Save" type="object" name="execute"
                                class="btn-primary"/>
                        <button string="Discard" type="object" name="cancel"
                                class="btn-secondary" special="cancel"/>
                    </header>

                    <div class="app_settings_block">

                        <h2>Margin Block</h2>
                        <p class="text-muted">
                            Block order confirmation and invoicing when a line's margin
                            falls below the configured minimum.
                        </p>

                        <div class="row mt16 o_settings_container">
                            <div class="col-12 col-lg-6 o_setting_box">
                                <div class="o_setting_left_pane">
                                    <field name="sale_margin_block_enabled"/>
                                </div>
                                <div class="o_setting_right_pane">
                                    <label for="sale_margin_block_enabled"
                                           string="Enable Margin % Block"/>
                                    <div class="text-muted">
                                        Orders whose margin % is below the minimum will be blocked.
                                    </div>
                                    <div invisible="not sale_margin_block_enabled" class="mt8">
                                        <label for="sale_margin_minimum"
                                               string="Minimum Margin %"/>
                                        <div class="d-flex align-items-center gap-1">
                                            <field name="sale_margin_minimum" widget="float"
                                                   style="max-width:100px;"/>
                                            <span>%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h2 class="mt32">Cost Recovery Block</h2>
                        <p class="text-muted">
                            Block when the selling price is below a percentage of the product cost.
                            100 % = price must at least equal cost.
                        </p>

                        <div class="row mt16 o_settings_container">
                            <div class="col-12 col-lg-6 o_setting_box">
                                <div class="o_setting_left_pane">
                                    <field name="sale_cost_block_enabled"/>
                                </div>
                                <div class="o_setting_right_pane">
                                    <label for="sale_cost_block_enabled"
                                           string="Enable Cost Recovery % Block"/>
                                    <div class="text-muted">
                                        Orders whose cost recovery % is below the minimum will be blocked.
                                    </div>
                                    <div invisible="not sale_cost_block_enabled" class="mt8">
                                        <label for="sale_cost_minimum"
                                               string="Minimum Cost Recovery %"/>
                                        <div class="d-flex align-items-center gap-1">
                                            <field name="sale_cost_minimum" widget="float"
                                                   style="max-width:100px;"/>
                                            <span>%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <h2 class="mt32">Override Options</h2>

                        <div class="row mt16 o_settings_container">
                            <div class="col-12 col-lg-6 o_setting_box">
                                <div class="o_setting_left_pane">
                                    <field name="sale_margin_block_warn_only"/>
                                </div>
                                <div class="o_setting_right_pane">
                                    <label for="sale_margin_block_warn_only"
                                           string="Warn Only (no hard block)"/>
                                    <div class="text-muted">
                                        When enabled, threshold breaches post a chatter warning
                                        instead of blocking the operation. Users with the
                                        <b>Can Override Margin/Cost Block</b> group are never
                                        hard-blocked regardless of this setting.
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                </form>
            </field>
        </record>

        <!-- Window action that opens the config form -->
        <record id="action_smb_config" model="ir.actions.act_window">
            <field name="name">Margin &amp; Cost Block</field>
            <field name="res_model">res.config.settings</field>
            <field name="view_mode">form</field>
            <field name="view_id" ref="view_smb_config_form"/>
            <field name="target">current</field>
            <field name="context">{'module': 'sale_margin_block'}</field>
        </record>

        <!-- Menu entry under Sales > Configuration -->
        <menuitem id="menu_smb_config"
                  name="Margin &amp; Cost Block"
                  parent="sale.menu_sale_config"
                  action="action_smb_config"
                  sequence="100"/>

    </data>
</odoo>